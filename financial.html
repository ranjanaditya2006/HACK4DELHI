<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NIRVACHANNEX – Financial simulator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="ui-system.css" />
  <style>
    /* Pop-up Tooltip Style (Bottom-Left) */
    #chart-tooltip {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 280px;
      background: rgba(10, 15, 30, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: none;
      pointer-events: none;
      font-family: 'Inter', system-ui, sans-serif;
      animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .tooltip-header {
      font-size: 0.95rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .tooltip-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      font-size: 0.85rem;
      color: #94a3b8;
    }
    
    .tooltip-val {
      color: #e2e8f0;
      font-weight: 600;
    }

    .bar {
      transition: height 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="brand-block">
        <div class="brand-logo">
          <img src="nirvachan logo.jpg" alt="NirvachanNex logo" />
        </div>
        <div>
          <div class="brand-text-main">NIRVACHANNEX</div>
          <div class="brand-text-sub">ONE NATION · ONE ELECTION</div>
        </div>
      </div>
      <nav class="app-nav">
        <a class="nav-pill nav-active" href="overview.html">Overview</a>
        <a class="nav-pill nav-active" href="governance.html">Governance</a>
        <a class="nav-pill nav-active" href="administrative.html">Administrative</a>
        <a class="nav-pill nav-active" href="financial.html">Financial</a>
        <a class="nav-pill nav-active" href="constitutional.html">Constitutional</a>
        <a href="delhi.html" class="nav-pill nav-active">Delhi Model</a>
        <a class="nav-pill nav-active" href="stakeholders.html">Stakeholders</a>
        <a class="nav-pill nav-active" href="federalism-solution.html">Federal Model </a>
        <a class="nav-pill nav-active" href="hung-assembly-solution.html">Fallback</a>
    </header>

    <main class="overview-grid">
      <section class="glass-panel">
        <div class="panel-glow"></div>
        <div class="panel-header">
          <div class="panel-title-block">
            <div class="panel-title">Logistics spend per voter</div>
            <div class="panel-subtitle">
              Paired bars show per‑voter logistics cost in the viewed scenario and the alternative for each metro.
            </div>
          </div>
          <div class="panel-tag">Financial module</div>
        </div>

        <div class="scenario-strip">
          <div class="scenario-toggle">
            <button class="scenario-btn scenario-btn-active" data-scenario="current">Current system</button>
            <button class="scenario-btn" data-scenario="onoe">Synchronised ONOE</button>
          </div>
          <div class="scenario-badge" id="fin-scenario-note">
            Current system as baseline. Δ shows ONOE‑linked savings.
          </div>
        </div>

        <div class="kpi-grid" id="fin-kpi-grid"></div>

        <div class="chart-section">
          <div class="chart-shell">
            <div class="chart-header-text">
              City‑wise logistics cost per voter
            </div>
            <div class="chart-subtext">
              Hover each bar to see per‑voter cost and 5‑year city‑level spend in the respective scenario.
            </div>
            <div class="chart-area">
              <div class="chart-grid"></div>
              <div class="chart-inner">
                <div class="chart-root" id="fin-chart-root"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="verdict-text" id="fin-verdict"></div>
      </section>

      <section class="glass-panel-soft">
        <div class="right-panel-inner">
          <h2 style="font-size:0.92rem;margin-bottom:4px;">Financial controls</h2>
          <p class="right-intro">
            This saving factor is shared with the overview module. Combine with realistic governance and admin assumptions.
          </p>

          <div class="metric-stack">
            <div class="metric-card">
              <div class="metric-top">
                <div class="metric-title">ONOE logistics saving factor</div>
                <div class="metric-icon" style="background:linear-gradient(135deg,#4ef2ff,#88ffea);">
                  L
                </div>
              </div>
              <div class="metric-value"><span id="fin-saving-label">0.90</span> ×</div>
              <div class="metric-caption">
                Multiplier applied to logistics cost in ONOE. 0.90 ≈ 10% saving over current.
              </div>
              <input id="fin-saving-slider" type="range" min="0.7" max="1" step="0.05" value="0.9" style="width:100%;margin-top:6px;" />
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer>© 2025 NirvachanNex – Financial Simulator</footer>
  </div>

  <div id="chart-tooltip"></div>

  <script>
    const finCities = [
      { name: "Mumbai",     voters: 9.8, polls:3, costMin:12, costMax:15 },
      { name: "Delhi (NCT)",voters:14.3, polls:3, costMin:18, costMax:22 },
      { name: "Bengaluru",  voters: 9.5, polls:3, costMin:14, costMax:16 },
      { name: "Hyderabad",  voters: 4.0, polls:3, costMin: 8, costMax:10 },
      { name: "Chennai",    voters: 3.8, polls:2, costMin: 9, costMax:11 },
      { name: "Kolkata",    voters: 3.3, polls:3, costMin:10, costMax:13 },
      { name: "Ahmedabad",  voters: 3.9, polls:2, costMin: 7, costMax: 9 },
      { name: "Pune",       voters: 3.3, polls:3, costMin: 8, costMax:10 },
      { name: "Surat",      voters: 3.1, polls:2, costMin: 6, costMax: 8 },
      { name: "Jaipur",     voters: 4.1, polls:2, costMin: 7, costMax: 9 }
    ];

    const finParams = { savingONOE: 0.9 };
    let finScenario = "current";

    function computeFinMetrics(scenario) {
      const factor = scenario === "current" ? 1 : finParams.savingONOE;

      let totalCostCr = 0;
      let totalVotersM = 0;

      const perCity = finCities.map(c => {
        // Logic change: If scenario is ONOE, polls = 1. Else use city data.
        const effectivePolls = scenario === "onoe" ? 1 : c.polls;
        
        const avgCr  = (c.costMin + c.costMax) / 2;
        
        // Calculate cost based on effective polls
        const costCr = avgCr * effectivePolls * factor;
        const cpv    = (costCr * 1e7) / (c.voters * 1e6);

        totalCostCr  += costCr;
        totalVotersM += c.voters;
        
        return { 
            ...c, 
            avgCr, 
            costCr, 
            cpv, 
            effectivePolls // Return this so we can show it in tooltip
        };
      });

      const avgCostPerVoter = (totalCostCr * 1e7) / (totalVotersM * 1e6);
      return { perCity, totalCostCr, avgCostPerVoter };
    }

    const finKpiGrid   = document.getElementById("fin-kpi-grid");
    const finChartRoot = document.getElementById("fin-chart-root");
    const finVerdict   = document.getElementById("fin-verdict");
    const finScenarioNote = document.getElementById("fin-scenario-note");
    const tooltipElFin = document.getElementById("chart-tooltip");

    function showFinTooltip(data, scenarioLabel) {
      // Determine color based on scenario
      const valColor = scenarioLabel.includes("ONOE") ? "#d946ef" : "#4ef2ff";

      const content = `
         <div class="tooltip-header">${data.name} · ${scenarioLabel}</div>
         <div class="tooltip-row">
            <span>Cost per voter:</span>
            <span class="tooltip-val" style="color:${valColor}">₹${data.cpv.toFixed(0)}</span>
         </div>
         <div class="tooltip-row">
            <span>Total cost (5 yrs):</span>
            <span class="tooltip-val">₹${data.costCr.toFixed(1)} Cr</span>
         </div>
         <div class="tooltip-row">
            <span>Polls in 5 yrs:</span>
            <span class="tooltip-val">${data.effectivePolls}</span>
         </div>
      `;

      tooltipElFin.innerHTML = content;
      tooltipElFin.style.display = "block";
    }

    function hideFinTooltip() { tooltipElFin.style.display = "none"; }

    function renderFinKPIs() {
      finKpiGrid.innerHTML = "";
      const cur  = computeFinMetrics("current");
      const onoe = computeFinMetrics("onoe");

      const base  = finScenario === "current" ? cur  : onoe;
      const other = finScenario === "current" ? onoe : cur;
      const sign  = finScenario === "current" ? 1 : -1;

      const cards = [
        {
          label: "Total logistics cost · 5 yrs",
          value: base.totalCostCr,
          delta: (other.totalCostCr - base.totalCostCr) * sign,
          unit: " Cr",
          better: "lower"
        },
        {
          label: "Average cost per voter",
          value: base.avgCostPerVoter,
          delta: (other.avgCostPerVoter - base.avgCostPerVoter) * sign,
          unit: " ₹",
          better: "lower"
        }
      ];

      cards.forEach(c => {
        const edge =
          c.delta === 0
            ? " · Neutral"
            : (c.better === "lower" && c.delta < 0) ||
              (c.better === "higher" && c.delta > 0)
            ? " · Other scenario edge"
            : " · Current view edge";

        const div = document.createElement("div");
        div.className = "kpi-card";
        div.innerHTML = `
          <div class="kpi-label">${c.label}</div>
          <div class="kpi-value">${c.value.toFixed(1)}${c.unit}</div>
          <div class="kpi-delta">
            Δ ${(c.delta >= 0 ? "+" : "") + c.delta.toFixed(1)}${c.unit}${edge}
          </div>`;
        finKpiGrid.appendChild(div);
      });

      finScenarioNote.textContent =
        finScenario === "current"
          ? "Current system as baseline. Δ shows ONOE‑linked savings."
          : "ONOE as baseline. Δ shows cost penalty if cycles remain staggered.";
    }

    function renderFinChart() {
      finChartRoot.innerHTML = "";
      const metrics = computeFinMetrics(finScenario);
      // "Other" scenario data for comparison bar
      const otherMetric = computeFinMetrics(finScenario === "current" ? "onoe" : "current");

      const height = finChartRoot.clientHeight || 160;
      const barWidth = 18;
      const totalWidth = finChartRoot.clientWidth || 640;
      const groupWidth = barWidth * 2 + 6;
      const x0 = 8;
      const gap =
        (totalWidth - x0 * 2 - groupWidth * metrics.perCity.length) /
        Math.max(metrics.perCity.length - 1, 1);

      let maxCpv = 0;
      metrics.perCity.forEach((c, i) => {
        maxCpv = Math.max(maxCpv, c.cpv, otherMetric.perCity[i].cpv);
      });

      metrics.perCity.forEach((c, idx) => {
        const o = otherMetric.perCity[idx];
        const xBase = x0 + idx * (groupWidth + gap);
        
        const hBase  = (c.cpv / maxCpv) * (height * 0.9);
        const hOther = (o.cpv / maxCpv) * (height * 0.9);

        // Bar A: The active scenario
        const barA = document.createElement("div");
        barA.className = "bar " + (finScenario === "current" ? "bar-current" : "bar-sync");
        barA.style.left = xBase + "px";
        barA.style.width = barWidth + "px";
        barA.style.height = hBase + "px";
        
        // Tooltip for Bar A
        const labelA = finScenario === "current" ? "Current System" : "ONOE";
        barA.addEventListener("mousemove", () => showFinTooltip(c, labelA));
        barA.addEventListener("mouseleave", hideFinTooltip);
        
        finChartRoot.appendChild(barA);

        // Bar B: The alternative scenario (comparison)
        const barB = document.createElement("div");
        barB.className = "bar " + (finScenario === "current" ? "bar-sync" : "bar-current");
        barB.style.left = xBase + barWidth + 3 + "px";
        barB.style.width = barWidth + "px";
        barB.style.height = hOther + "px";
        
        // Tooltip for Bar B
        const labelB = finScenario === "current" ? "ONOE" : "Current System";
        barB.addEventListener("mousemove", () => showFinTooltip(o, labelB));
        barB.addEventListener("mouseleave", hideFinTooltip);

        finChartRoot.appendChild(barB);

        const label = document.createElement("div");
        label.className = "bar-label";
        label.style.left = xBase + groupWidth / 2 + "px";
        label.style.bottom = "-18px";
        label.textContent = c.name.split(" ")[0];
        finChartRoot.appendChild(label);
      });

      const cur  = computeFinMetrics("current");
      const onoe = computeFinMetrics("onoe");
      const dCost = onoe.totalCostCr - cur.totalCostCr;

      finVerdict.textContent =
        "Across these metros, moving from the current system to ONOE changes 5‑year logistics outlay by " +
        (dCost >= 0 ? "+" : "") +
        dCost.toFixed(1) +
        " Cr. Hover bars for city‑wise spend and per‑voter cost.";
    }

    function renderFinAll() {
      renderFinKPIs();
      renderFinChart();
    }

    document.querySelectorAll(".scenario-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".scenario-btn")
          .forEach(b => b.classList.remove("scenario-btn-active"));
        btn.classList.add("scenario-btn-active");
        finScenario = btn.dataset.scenario;
        renderFinAll();
      });
    });

    document.getElementById("fin-saving-slider").oninput = e => {
      finParams.savingONOE = Number(e.target.value);
      document.getElementById("fin-saving-label").textContent =
        Number(e.target.value).toFixed(2);
      renderFinAll();
    };

    window.addEventListener("resize", renderFinChart);
    renderFinAll();
  </script>
</body>
</html>
